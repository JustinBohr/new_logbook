<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.css" type="text/css"/>
        <link rel="stylesheet" href="css/style.css" type="text/css"/>
        <link rel="stylesheet" href="css/jquery.ias.css" type="text/css"/>

        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            a.disabled {
                text-decoration: none;
                color: black;
                cursor: default;
            }
        </style>

        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
          <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <title>Olog Logbook</title>
        <script src="js/jquery.js"></script>
        <script src="js/bootstrap-transition.js"></script>
        <script src="js/bootstrap-alert.js"></script>
        <script src="js/bootstrap-modal.js"></script>
        <script src="js/bootstrap-dropdown.js"></script>
        <script src="js/bootstrap-scrollspy.js"></script>
        <script src="js/bootstrap-tab.js"></script>
        <script src="js/bootstrap-tooltip.js"></script>
        <script src="js/bootstrap-popover.js"></script>
        <script src="js/bootstrap-button.js"></script>
        <script src="js/bootstrap-collapse.js"></script>
        <script src="js/bootstrap-carousel.js"></script>
        <script src="js/bootstrap-typeahead.js"></script>
        <script src="js/pure_min.js"></script>
        <script src="js/bootstrap-filestyle-0.1.0.min.js"></script>
        <script src="js/jquery.masonry.min.js"></script>
        <script src="js/jquery-ias.min.js"></script>
        <script src="js/jquery.infinitescroll.js"></script> 

        <script>serviceurl = "https://controls.frib.msu.edu/olog/resources/";</script>
        <script>logLimit = "15";</script>
        <!--<script>serviceurl = "http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/";</script>-->
        <script>rfn = null;</script>

    </head>
    <body>
        <input type='hidden' id='current_page'/>
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="#">Logbook</a>
                    <div class="btn-group pull-right">
                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="icon-user"></i> Username
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Profile</a></li>
                            <li class="divider"></li>
                            <li><a href="#">Sign Out</a></li>
                        </ul>
                    </div>
                    <!-- The drop down menu -->
                    <ul class="nav pull-right">
                        <li class="divider-vertical"></li>
                        <li class="dropdown">
                            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
                            <div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
                                <form action="POST" method="post" accept-charset="UTF-8">
                                    <input id="user_username" style="margin-bottom: 15px;" type="text" name="user[username]" size="30" />
                                    <input id="user_password" style="margin-bottom: 15px;" type="password" name="user[password]" size="30" />
                                    <input id="user_remember_me" style="float: left; margin-right: 10px;" type="checkbox" name="user[remember_me]" value="1" />
                                    <label class="string optional" for="user_remember_me"> Remember me</label>
                                    <input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
                                </form>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div>
            <a id="prev" style="display:none;" class='disabled' href="">&larr; Previous</a>
            <a id="next" style="display:none;" class="next" href="">Next &rarr;</a>
        </div>
        <script>
            $(function() {
                // Setup drop down menu
                $('.dropdown-toggle').dropdown();
                // Fix input element click problem
                $('.dropdown input, .dropdown label').click(function(e) {
                    e.stopPropagation();
                });
            });

            //----------------------------------------------------------------------
            //
            //              Format date and time
            //
            //----------------------------------------------------------------------
            var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            function printDate(unix) {
                var temp = new Date(unix);
                var dateStr = padStr(temp.getDate()) + ' ' +
                        monthNames[temp.getMonth()] + ' ' +
                        padStr(temp.getFullYear()) + ' ' +
                        padStr(temp.getHours()) + ':' +
                        padStr(temp.getMinutes()) + ':' +
                        padStr(temp.getSeconds());
                return dateStr;
            }

            function padStr(i) {
                return (i < 10) ? "0" + i : "" + i;
            }

            

            //----------------------------------------------------------------------
            //
            //              Directives
            //
            //----------------------------------------------------------------------

            var directives = {
                'div.log': {
                    'log <- context': {
                        '.createdDate': function(arg) {
                            return printDate(arg.item.createdDate);
                        },
                        '.id@id': function(arg) {
                            return 'log_' + arg.item.id;
                        },
                        '.open-edit@data-id': function(arg) {
                            return arg.item.id;
                        },
                        '.owner': 'log.owner',
                        '.logbook': {'logbook <- log.logbooks': {
                                '.+': '#{logbook.name}, '
                            }},
                        '.tag': {'tag <- log.tags': {
                                '.+': '#{tag.name}, '
                            }},
                        '.property': {'property <- log.properties': {
                                '.+': '#{property.name}, '
                            }},
                        '.level': 'log.level',
                        '.description': 'log.description',

                        '.attachments': {'attachment<-log.attachments': {
                                '.attachment@href': function(a) {
                                    return serviceurl + 'attachments/' + a.log.item.id + '/' + a.item.fileName;
                                },
                                'img@src': function(a) {
                                    if (a.item.thumbnail) {
                                        return serviceurl + 'attachments/' + a.log.item.id + '/' + a.item.fileName + ':thumbnail';
                                    } else {
                                        return null;
                                    }
                                },
                                '.nonImage': function(a) {
                                    if (!a.item.thumbnail) {
                                        return a.item.fileName;
                                    } else {
                                        return null;
                                    }
                                },
                                '.attachment@target': function(a) {
                                    return '_blank';
                                }
                            }}
                    }
                }
            };

            //----------------------------------------------------------------------
            //
            //              Document ready
            //
            //----------------------------------------------------------------------
            $(document).ready(function() {
            
                $('#current_page').val(0);
                pageNum = parseInt($('#current_page').val()) + 1;
                console.log(pageNum);
                $('#next').attr('href', serviceurl + 'logs?limit='+logLimit+ '&page=' + pageNum);
                
                $.get('_logs.tmpl.html', function(templates) {
                    
                    // Inject templates.
                    $('body').append(templates);
                    rfn = $('#logs_tmpl').compile(directives);
                    $('.logs').on('load',infScrollHandler);
                    
                    $.getJSON(serviceurl + 'logs?limit='+logLimit+'&page='+pageNum, function(logs) {
                        $('#target').append(rfn(logs));
                        $('.logs').trigger('load');
                        $(":file").filestyle({
                            icon: true,
                            classIcon: "icon-picture",
                            showFilename: false,
                            classButton: "btn",
                            buttonText: "",
                            textField: false
                        });
                        loadActionButtons();
                    });
                    $('div.well.row.log').hide();
                });
                
                loadLists();
               
            });
            
            //----------------------------------------------------------------------
            //
            //              Loads action buttons into each log entry
            //
            //----------------------------------------------------------------------
            function loadActionButtons() {
                $('div[id^="log_"]').hover(
                    function() { // Hover in
                        $(this).find('.action_buttons').show();
                    },
                    function() { // Hover out
                        $(this).find('.action_buttons').hide();
                    });
            }
            
            //----------------------------------------------------------------------
            //
            //              Loads tag/logbook selectors
            //
            //----------------------------------------------------------------------
            function loadLists() {
                // - - - - - - - -
                // Tags list
                // - - - - - - - -
                $.getJSON(serviceurl + 'tags/', function(tags) {
                    $.each(tags.tag, function(i, item) {
                        $('.modal-body #tag').append($('<option value="' + item.name + '">').text(item.name));
                    });
                });
                // - - - - - - - -
                // Books list
                // - - - - - - - -
                $.getJSON(serviceurl + 'logbooks/', function(books) {
                    $.each(books.logbook, function(i, item) {
                        $('.modal-body #book').append($('<option value="' + item.name + '">').text(item.name));
                    });
                });
            }
            
            //----------------------------------------------------------------------
            //
            //              Paste image from clipboard
            //
            //----------------------------------------------------------------------

            document.body.addEventListener("paste", function(e) {
                for (var i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].kind === "file" && e.clipboardData.items[i].type === "image/png") {
                        // get the blob
                        var imageFile = e.clipboardData.items[i].getAsFile();

                        // read the blob as a data URL
                        var fileReader = new FileReader();
                        fileReader.onloadend = function(e) {
                            // create an image
                            var image = document.createElement("IMG");
                            image.src = this.result;

                            // insert the image
                            var range = window.getSelection().getRangeAt(0);
                            range.insertNode(image);
                            range.collapse(false);

                            // set the selection to after the image
                            var selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        };

                        // TODO: Error Handling!
                        // fileReader.onerror = ...

                        fileReader.readAsDataURL(imageFile);

                        // prevent the default paste action
                        e.preventDefault();

                        // only paste 1 image at a time
                        break;
                    }
                }
            });

            //----------------------------------------------------------------------
            //
            //              Load info into edit modal
            //
            //----------------------------------------------------------------------
            $(document).on("click", ".open-edit", function() {
                var myLogId = $(this).data('id');
                // - - - - - - - - - - - -
                // Delete old attachments
                // - - - - - - - - - - - -
                $('#modalcontainer > div').remove();
                
                // - - - - - - - - - - - -
                // Clear selections
                // - - - - - - - - - - - -               
                $('option').each(function(opt) {
                    $(this).attr('selected',false);
                });
                // - - - - - - - - - - - -
                // Description/tags/books
                // - - - - - - - - - - - -
                $.getJSON(serviceurl + 'logs/' + myLogId, function(log) {
                    // Fill in description
                    $(".modal-body #description").val(log.description);
                    // Select tags
                    $.each(log.tags, function(i, item) {
                        $('.modal-body #tag').find('[value="' + item.name + '"]').attr('selected', 'selected').attr('id', 'active');
                    });
                    // Select books
                    $.each(log.logbooks, function(i, item) {
                        $('.modal-body #book').find('[value="' + item.name + '"]').attr('selected', 'selected').attr('id', 'active');
                    });    
                    $.each(log.logbooks, function(i,item) {
                        $('.modal-body #book').find('[value="'+item.name+'"]').attr('selected', 'selected');
                    });
                });
                
                // - - - - - - - -
                // Attachments
                // - - - - - - - -
                $.getJSON(serviceurl + 'attachments/' + myLogId, function(a) {
                    $.each(a.attachment, function(i, item) {
                        $('.modal-body #modalcontainer').append(
                                '<div id="modalattach" class="attachments masonry-brick">' +
                                '<a class="attachment fileName" href="' + serviceurl + 'attachments/' + myLogId + '/' + item.fileName +'" target="_blank">' +
                                '<div class="nonImage"></div>' +
                                '<img class="image" src="' + serviceurl + 'attachments/' + myLogId + '/' + item.fileName + ':thumbnail"/>' +
                                '</a></div>');
                    });
                });
            });           


            //----------------------------------------------------------------------
            //
            //              Show the edit modal
            //              
            //----------------------------------------------------------------------
            $('.edit_log').click(function() {
                $('#logForm').show('fast');
                $('#addNewLog').hide();
                $('#closeNewLog').show();
                $.getJSON(this.title);
            });


            //----------------------------------------------------------------------
            //
            //              Masonry for images
            //
            //----------------------------------------------------------------------
            var $container = $('#container');

            $container.imagesLoaded(function() {
                $container.masonry({
                    itemSelector: '.attachments'
                });
            });
            
            var $modalcontainer = $('#modalcontainer');

            $modalcontainer.imagesLoaded(function() {
                $modalcontainer.masonry({
                    itemSelector: '.attachments'
                });
            });
            
            //----------------------------------------------------------------------
            //
            //              Infinite scroll
            //
            //----------------------------------------------------------------------      
            function infScrollHandler() {
                $('.logs').infinitescroll({

                    navSelector  	: "a#next",
                    nextSelector 	: "a#next",
                    itemSelector 	: "#target",
//                    debug		: true,
                    dataType	 	: 'json',
                    appendCallback	: false // USE FOR PREPENDING
                }, function( response ) {
                    $('#target').append(rfn(response));
                    
                    page = parseInt($('#current_page').val()) + 1;
                    $('#current_page').val(page);
                    loadActionButtons();
                    loadLists();
                });
            }
            
        </script>
        <div class="container">
                <div id="target"></div>
        </div>

        <div id="edit" class="modal hide fade in bigModal" style="display: none; ">
            <div class="bigModal-header span7">
                <a class="close" data-dismiss="modal">x</a>
                <h3>Edit Log</h3>
            </div>
            <div class="row">
                <div class="modal-body span8">
                    <div class="row">
                        <div class="span2"><label>Book</label>
                            <select id="book" class="span2" multiple="multiple">
                            </select>
                        </div>
                        <div class="span2"><label>Tag</label>
                            <select id="tag" class="offset1 span2" multiple="multiple">
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="span8"><label>Description</label>
                            <textarea class="input-block-level" id="description" rows="10" style="resize: none;"></textarea>
                        </div>
                    </div>
                    <div id="modalcontainer" class="row span7 clearfix masonry">
                        
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <a href="#" class="btn btn-success">Submit</a>
            </div>
        </div>
        <div id="add" class="modal hide fade in" style="display: none; ">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">x</a>
                <h3>Add Attachment</h3>
            </div>
            <div class="modal-body">
                <div class="span4" contenteditable="true"></div>
            </div>
            <div class="modal-footer">
                <form class="span1" style='margin: 0px; width: 40px; padding: 0px' action="localhost" method="POST" enctype="multipart/form-data">
                    <input type="file" name="file" id="fileItem">
                    <input type="hidden" name="id" value="" />
                </form>
                <a href="#" class="btn btn-success">Call to action</a>
            </div>
        </div>
    </body>

</html>
