<!--
To change this template, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="">
        <meta name="author" content="">

        <!-- Le styles -->
        <link rel="stylesheet" href="css/bootstrap.css">
        <link rel="stylesheet" href="css/bootstrap-responsive.css" type="text/css"/>
        <link rel="stylesheet" href="css/style.css" type="text/css"/>
        <link rel="stylesheet" href="css/jquery.ias.css" type="text/css"/>

        <style type="text/css">
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
            a.disabled {
                text-decoration: none;
                color: black;
                cursor: default;
            }
        </style>

        <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
          <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <title>Olog Logbook</title>
        <script src="js/jquery.js"></script>
        <script src="js/bootstrap-transition.js"></script>
        <script src="js/bootstrap-alert.js"></script>
        <script src="js/bootstrap-modal.js"></script>
        <script src="js/bootstrap-dropdown.js"></script>
        <script src="js/bootstrap-scrollspy.js"></script>
        <script src="js/bootstrap-tab.js"></script>
        <script src="js/bootstrap-tooltip.js"></script>
        <script src="js/bootstrap-popover.js"></script>
        <script src="js/bootstrap-button.js"></script>
        <script src="js/bootstrap-collapse.js"></script>
        <script src="js/bootstrap-carousel.js"></script>
        <script src="js/bootstrap-typeahead.js"></script>
        <script src="js/pure_min.js"></script>
        <script src="js/bootstrap-filestyle-0.1.0.min.js"></script>
        <script src="js/jquery.masonry.min.js"></script>
        <script src="js/jquery-ias.min.js"></script>
        <!--<script src="js/jquery.simplePagination.js"></script>-->
        <script src="js/jquery.infinitescroll.js"></script> 

        <script>serviceurl = "https://controls.frib.msu.edu/olog/resources/";</script>
        <script>logLimit = "limit=15";</script>
        <!--<script>serviceurl = "http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/";</script>-->


    </head>
    <body>
        <input type='hidden' id='current_page' />
        <div class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="#">Logbook</a>
                    <div class="btn-group pull-right">
                        <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="icon-user"></i> Username
                            <span class="caret"></span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Profile</a></li>
                            <li class="divider"></li>
                            <li><a href="#">Sign Out</a></li>
                        </ul>
                    </div>
<!--                    <div class="nav-collapse">
                        <ul class="nav">
                            <li class="active"><a href="index.html">Home</a></li>
                        </ul>
                    </div>/.nav-collapse -->
                    <!-- The drop down menu -->
                    <ul class="nav pull-right">
                        <li class="divider-vertical"></li>
                        <li class="dropdown">
                            <a class="dropdown-toggle" href="#" data-toggle="dropdown">Sign In <strong class="caret"></strong></a>
                            <div class="dropdown-menu" style="padding: 15px; padding-bottom: 0px;">
                                <form action="POST" method="post" accept-charset="UTF-8">
                                    <input id="user_username" style="margin-bottom: 15px;" type="text" name="user[username]" size="30" />
                                    <input id="user_password" style="margin-bottom: 15px;" type="password" name="user[password]" size="30" />
                                    <input id="user_remember_me" style="float: left; margin-right: 10px;" type="checkbox" name="user[remember_me]" value="1" />
                                    <label class="string optional" for="user_remember_me"> Remember me</label>
                                    <input class="btn btn-primary" style="clear: left; width: 100%; height: 32px; font-size: 13px;" type="submit" name="commit" value="Sign In" />
                                </form>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="pageContainer" class="container">
            <div id="pageNav" class="pagination">
                <ul><li><a id="home" href="javascript:home();"><i class="icon-home"></i> Home</a></li></ul>
                 <ul>
                <li id="paging" class="previous_link">
                <a id="prev" class='disabled' href="javascript:previous();">&larr; Previous</a>
                </li>
                <li>
               <a id="next" href="javascript:next();">Next &rarr;</a>
                </li>
                </ul>
            </div>
        </div>
        <script>
            $(function() {
                // Setup drop down menu
                $('.dropdown-toggle').dropdown();
                // Fix input element click problem
                $('.dropdown input, .dropdown label').click(function(e) {
                    e.stopPropagation();
                });
            });
            //----------------------------------------------------------------------
            //
            //              On hover show actions buttons in bottom right
            //
            //----------------------------------------------------------------------    
            $(document).ready(function() {
                $('div[id^="log_"]').hover(
                        function() { // Hover in
                            $(this).find('.action_buttons').show();
                        },
                        function() { // Hover out
                            $(this).find('.action_buttons').hide();
                        });
            });
            //--------------------------------------------------
            //	Format the date and time
            var monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            function printDate(unix) {
                var temp = new Date(unix);
                var dateStr = padStr(temp.getDate()) + ' ' +
                        monthNames[temp.getMonth()] + ' ' +
                        padStr(temp.getFullYear()) + ' ' +
                        padStr(temp.getHours()) + ':' +
                        padStr(temp.getMinutes()) + ':' +
                        padStr(temp.getSeconds());
                return dateStr;
            }

            function padStr(i) {
                return (i < 10) ? "0" + i : "" + i;
            }

            //----------------------------------------------------------------------
            //
            //              Directives
            //
            //----------------------------------------------------------------------

            var directives = {
                'div.log': {
                    'log <- context': {
                        '@class+': (function(arg) {
                            return (arg.pos % 2 === 0) ? ' even' : ' odd';
                        }),
                        '.createdDate': function(arg) {
                            return printDate(arg.item.createdDate);
                        },
                        '.id@id': function(arg) {
                            return 'log_' + arg.item.id;
                        },
                        '.open-edit@data-id': function(arg) {
                            return arg.item.id;
                        },
                        '.owner': 'log.owner',
                        '.logbook': {'logbook <- log.logbooks': {
                                '.+': '#{logbook.name}, '
                            }},
                        '.tag': {'tag <- log.tags': {
                                '.+': '#{tag.name} '
                            }},
                        '.property': {'property <- log.properties': {
                                '.+': '#{property.name}, '
                            }},
                        '.level': 'log.level',
                        '.description': 'log.description',
                        //
                        //Trying to get attachments to be filled in

                        '.attachments': {'attachment<-log.attachments': {
                                '.attachment@href': function(a) {
                                    return serviceurl + 'attachments/' + a.log.item.id + '/' + a.item.fileName;
                                },
                                'img@src': function(a) {
                                    if (a.item.thumbnail) {
                                        return serviceurl + 'attachments/' + a.log.item.id + '/' + a.item.fileName + ':thumbnail';
                                    } else {
                                        return null;
                                    }
                                },
                                '.nonImage': function(a) {
                                    if (!a.item.thumbnail) {
                                        return a.item.fileName;
                                    } else {
                                        return null;
                                    }
                                }
                            }}
                    }
                }
            };
            //----------------------------------------------------------------------
            //
            //              Render function
            //
            //----------------------------------------------------------------------


//            function render(pageNum) {
////                $.getJSON('http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/logs?'+logLimit, 'page=' + $('#page').val(), function(logs) {
//                $.getJSON('jsonTest.json', function(logs) {
//                    $('#target').append(rfn(logs));
//                    //$('#target').html(rfn(logs));
//                });
//            }

            //----------------------------------------------------------------------
            //
            //              Document ready
            //
            //----------------------------------------------------------------------

            $(document).ready(function() {
                $('#page').val(1);
                $('#current_page').val(1);
                pageNum = 1;
                $.get('_logs.tmpl.html', function(templates) {
                    // Inject templates.
                    $('body').append(templates);
                    rfn = $('#logs_tmpl').compile(directives);
//                    console.log(directives);
//                    console.log(rfn(directives));
                    $('.logs').on('load',infScrollRaise);
                    $.getJSON(serviceurl + 'logs?'+logLimit+'&page=1', function(logs) {
                        $('#target').append(rfn(logs));
                        $('.logs').trigger('load');
//                        console.log(logs);
//                        console.log(rfn(logs));
//                        $('#target').html(rfn(logs));
                        // Custom fire event
                        // http://www.sitepoint.com/jquery-custom-events/
                        $(":file").filestyle({
                            icon: true,
                            classIcon: "icon-picture",
                            showFilename: false,
                            classButton: "btn",
                            buttonText: "",
                            textField: false
                        });
                        $('.logs').on('load',infScrollRaise);
                        $('div[id^="log_"]').hover(
                                function() { // Hover in
                                    $(this).find('.action_buttons').show();
                                },
                                function() { // Hover out
                                    $(this).find('.action_buttons').hide();
                                });
                    });
//                    render();
//                    $('#page').change(render);
                    $('div.well.row.log').hide();
                });
                // - - - - - - - -
                // Tags list
                // - - - - - - - -
//                $.getJSON('http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/tags/', function(tags) {
                $.getJSON(serviceurl + 'tags/', function(tags) {
                    $.each(tags.tag, function(i, item) {
                        $('.modal-body #tag').append($('<option value="' + item.name + '">').text(item.name));
                    });
                });
                // - - - - - - - -
                // Books list
                // - - - - - - - -
//                $.getJSON('http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/logbooks/', function(tags) {
                $.getJSON(serviceurl + 'logbooks/', function(books) {
                    $.each(books.logbook, function(i, item) {
                        $('.modal-body #book').append($('<option value="' + item.name + '">').text(item.name));
                    });
                });
                $('.logs').on('load',infScrollRaise);
            });

// Custom listener for custom fire event above
// http://www.sitepoint.com/jquery-custom-events/
            $(document).on('infScroll',infScrollHandler);
            //----------------------------------------------------------------------
            //
            //              Paste image from clipboard
            //
            //----------------------------------------------------------------------

            document.body.addEventListener("paste", function(e) {
                for (var i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].kind === "file" && e.clipboardData.items[i].type === "image/png") {
                        // get the blob
                        var imageFile = e.clipboardData.items[i].getAsFile();

                        // read the blob as a data URL
                        var fileReader = new FileReader();
                        fileReader.onloadend = function(e) {
                            // create an image
                            var image = document.createElement("IMG");
                            image.src = this.result;

                            // insert the image
                            var range = window.getSelection().getRangeAt(0);
                            range.insertNode(image);
                            range.collapse(false);

                            // set the selection to after the image
                            var selection = window.getSelection();
                            selection.removeAllRanges();
                            selection.addRange(range);
                        };

                        // TODO: Error Handling!
                        // fileReader.onerror = ...

                        fileReader.readAsDataURL(imageFile);

                        // prevent the default paste action
                        e.preventDefault();

                        // only paste 1 image at a time
                        break;
                    }
                }
            });

            //----------------------------------------------------------------------
            //
            //              Load info into edit modal
            //
            //----------------------------------------------------------------------
            $(document).on("click", ".open-edit", function() {
                var myLogId = $(this).data('id');
                // - - - - - - - - - - - -
                // Delete old attachments
                // - - - - - - - - - - - -
                $('#modalcontainer > div').remove();
                
                // - - - - - - - - - - - -
                // Clear selections
                // - - - - - - - - - - - -               
                $('option').each(function(opt) {
                    $(this).attr('selected',false);
                });
                // - - - - - - - - - - - -
                // Description/tags/books
                // - - - - - - - - - - - -
//                $.getJSON('http://berryman-win7.intranet.nscl.msu.edu:8080/Olog/resources/logs/' + myLogId, function(log) {
                $.getJSON(serviceurl + 'logs/' + myLogId, function(log) {
                    // Fill in description
                    $(".modal-body #description").val(log.description);
                    // Select tags
                    $.each(log.tags, function(i, item) {
                        $('.modal-body #tag').find('[value="' + item.name + '"]').attr('selected', 'selected').attr('id', 'active');
                    });
                    // Select books
                    $.each(log.logbooks, function(i, item) {
                        $('.modal-body #book').find('[value="' + item.name + '"]').attr('selected', 'selected').attr('id', 'active');
                    });    
                    $.each(log.logbooks, function(i,item) {
                        $('.modal-body #book').find('[value="'+item.name+'"]').attr('selected', 'selected');
                    });
                });
                
                // - - - - - - - -
                // Attachemtns
                // - - - - - - - -
                $.getJSON(serviceurl + 'attachments/' + myLogId, function(a) {
                    $.each(a.attachment, function(i, item) {
                        $('.modal-body #modalcontainer').append(
                                '<div id="modalattach" class="attachments masonry-brick">' +
                                '<a class="attachment fileName" href="' + serviceurl + 'attachments/' + myLogId + '/' + item.fileName +'">' +
                                '<div class="nonImage"></div>' +
                                '<img class="image" src="' + serviceurl + 'attachments/' + myLogId + '/' + item.fileName + ':thumbnail"/>' +
                                '</a></div>');
                    });
                });
            });           


            //----------------------------------------------------------------------
            //
            //              Show the edit modal
            //              
            //----------------------------------------------------------------------
            $('.edit_log').click(function() {
                $('#logForm').show('fast');
                $('#addNewLog').hide();
                $('#closeNewLog').show();
                $.getJSON(this.title);
            });


            //----------------------------------------------------------------------
            //
            //              Masonry for images
            //
            //----------------------------------------------------------------------
            var $container = $('#container');

            $container.imagesLoaded(function() {
                $container.masonry({
                    itemSelector: '.attachments'
                });
            });
            
            var $modalcontainer = $('#modalcontainer');

            $modalcontainer.imagesLoaded(function() {
                $modalcontainer.masonry({
                    itemSelector: '.attachments'
                });
            });
        
            //----------------------------------------------------------------------
            //
            //              Pagination
            //
            //----------------------------------------------------------------------
           function home() {
               go_to_page(1);
           }
           function previous() {

                new_page = parseInt($('#current_page').val()) - 1;

                if (new_page !== 0) {
                    go_to_page(new_page);
                }
            }

            function next() {
                new_page = parseInt($('#current_page').val()) + 1;
                go_to_page(new_page);
            }
            function go_to_page(pageNum) {
                $.getJSON(serviceurl+'logs?'+logLimit, 'page=' + pageNum, function(logs) {
//                    console.log(logs);
//                    $('#target').html(rfn(logs));
                    $('#current_page').val(pageNum);
                    // Disables the previous button at page 1
                    if (pageNum == 1) {
//                        $('.container #prev a').val('disabled');
                        document.getElementById('prev').className += ' disabled';
                    }
                    else {
                        document.getElementById('prev').className -= ' disabled';
                    }
                        $('#target').append(rfn(logs));
                        $('#target').html(rfn(logs));
                        $(":file").filestyle({
                            icon: true,
                            classIcon: "icon-picture",
                            showFilename: false,
                            classButton: "btn",
                            buttonText: "",
                            textField: false
                        });
                        $('div[id^="log_"]').hover(
                                function() { // Hover in
                                    $(this).find('.action_buttons').show();
                                },
                                function() { // Hover out
                                    $(this).find('.action_buttons').hide();
                                });
                });
            }
            
//            $(function() {
//                $('#paging').pagination({
//                    items:              100,
//                    itemsOnPage:        10,
//                    hrefTextPrefix:     'page=',
////                    cssStyle: 'light-theme'
//                });
//            });


//            $('#content').infinitescroll({
//
//              navSelector  : "div#pageNav",            
//                             // selector for the paged navigation (it will be hidden)
//              nextSelector : "div#pageNav a.next_link:last",    
//                             // selector for the NEXT link (to page 2)
//              itemSelector : "#content div.post"          
//                             // selector for all items you'll retrieve
//            });
//        jQuery.ias({
//                pagination:             '#pageContainer .pagination',
//                container:              '.logs',
//                item:                   '.row',
//                next:                   '.next a',
//                loader:                 '<img src="img/loader.gif"/>',
//                triggerPageThreshold:   2
//        });
            //----------------------------------------------------------------------
            // Needs to fire for a custom event after the PURE template loads
            // lines with comments about 257,299
            
            function infScrollRaise(e) {
//                e.preventDefault();
                $.event.trigger({
                    type: 'infScroll'
                });
            }
            
            function infScrollHandler() {
                $('.logs').infinitescroll({

                    // callback		: function () { console.log('using opts.callback'); },
                    navSelector  	: "a#next",
                    nextSelector 	: "a#next",
                    itemSelector 	: "#target",
                    debug		: true,
                    dataType	 	: 'json',
                    appendCallback	: false // USE FOR PREPENDING
                    // pathParse     	: function( pathStr, nextPage ){ return pathStr.replace('2', nextPage ); }
                }, function( response ) {
                    console.log(response);
                    var jsonData = response.results;
                                $theCntr = $("#target");
                                var newElements = "";
                                //var newItems = new Array();
                                for(var i=0;i<jsonData.length;i++) {
                                    var item = $(_renderItem(jsonData[i]));
                                    //item.css({ opacity: 0 });
                                    $theCntr.append(item);
                                    //newItems.push(item.attr('id'));
                                }
                                //_addMasonryItem(newItems);
                });
            }
            //----------------------------------------------------------------------
        </script>
        <div class="container"><div id="target"></div></div>

        <!--    <a id="next" href="mobile2.json"></a>
        
            <script>
        
        
                //----------------------------------------------------------------------
                //
                //              Infinite scroll with JSON
                //
                //----------------------------------------------------------------------        
        
                var _renderItem = function(data) {
                return "<p>Title :" + data.title + "</p>";
                };
        
        
                $('#content').infinitescroll({
        
                        navSelector : "a#next:last",
                        nextSelector : "a#next:last",
                        itemSelector : "#content p",
                        debug	: true,
                        dataType	: 'json',
                        appendCallback	: false, // USE FOR PREPENDING
                }, function( response ) {
                    var jsonData = response.results;
                                $theCntr = $("#content");
                                for(var i=0;i<jsonData.length;i++) {
                                    var item = $(_renderItem(jsonData[i]));
                                    $theCntr.append(item);
                                }
                        });
            </script>-->
        <div id="edit" class="modal hide fade in bigModal" style="display: none; ">
            <div class="bigModal-header span7">
                <a class="close" data-dismiss="modal">x</a>
                <h3>Edit Log</h3>
            </div>
            <div class="row">
                <div class="modal-body span8">
                    <div class="row">
                        <div class="span2"><label>Book</label>
                            <select id="book" class="span2" multiple="multiple">
                            </select>
                        </div>
                        <div class="span2"><label>Tag</label>
                            <select id="tag" class="offset1 span2" multiple="multiple">
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="span8"><label>Description</label>
                            <textarea class="input-block-level" id="description" rows="10" style="resize: none;"></textarea>
                        </div>
                    </div>
                    <div id="modalcontainer" class="row span7 clearfix masonry">
                        
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <a href="#" class="btn btn-success">Submit</a>
            </div>
        </div>
        <div id="add" class="modal hide fade in" style="display: none; ">
            <div class="modal-header">
                <a class="close" data-dismiss="modal">x</a>
                <h3>Add Attachment</h3>
            </div>
            <div class="modal-body">
                <div class="span4" contenteditable="true"></div>
            </div>
            <div class="modal-footer">
                <form class="span1" style='margin: 0px; width: 40px; padding: 0px' action="localhost" method="POST" enctype="multipart/form-data">
                    <input type="file" name="file" id="fileItem">
                    <input type="hidden" name="id" value="" />
                </form>
                <a href="#" class="btn btn-success">Call to action</a>
            </div>
        </div>
    </body>

</html>
